services:
  mock-llm:
    build:
      context: ..
      dockerfile: Dockerfile
      target: development
    command: uv run uvicorn loadtests.mock_llm_server:app --host 0.0.0.0 --port 8001
    ports:
      - "8001:8001"
    environment:
      - MOCK_LLM_DELAY_MS=100
      - MOCK_LLM_RESPONSE=This is a mocked AI response for load testing.
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - loadtest_network

  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: loadtest
      POSTGRES_PASSWORD: loadtest
      POSTGRES_DB: qna_loadtest
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U loadtest -d qna_loadtest"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - loadtest_network

  app:
    build:
      context: ..
      dockerfile: Dockerfile
      target: development
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://loadtest:loadtest@db:5432/qna_loadtest
      - LITELLM_API_BASE=http://mock-llm:8001/v1
      - LITELLM_API_KEY=mock-key-for-load-testing
      - DEBUG=false
      - LOG_LEVEL=WARNING
    depends_on:
      mock-llm:
        condition: service_healthy
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - loadtest_network

  locust-master:
    image: locustio/locust:2.32.0
    ports:
      - "8089:8089"
    volumes:
      - ..:/app
    working_dir: /app
    command: >
      -f loadtests/locustfile.py
      --master
      --host=http://app:8000
    depends_on:
      app:
        condition: service_healthy
    networks:
      - loadtest_network

  locust-worker:
    image: locustio/locust:2.32.0
    volumes:
      - ..:/app
    working_dir: /app
    command: >
      -f loadtests/locustfile.py
      --worker
      --master-host=locust-master
    depends_on:
      - locust-master
    deploy:
      replicas: 4
    networks:
      - loadtest_network

networks:
  loadtest_network:
    driver: bridge
